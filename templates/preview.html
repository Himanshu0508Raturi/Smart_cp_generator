{% extends "base.html" %}

{% block title %}Contract Preview - {{ contract.contract_name }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="fas fa-eye me-2"></i>{{ contract.contract_name }}
                </h2>
                <p class="text-muted mb-0">
                    Generated on {{ contract.created_at.strftime('%B %d, %Y at %I:%M %p') if contract.created_at else 'Unknown' }}
                </p>
            </div>
            <div>
                <span class="badge bg-{{ 'success' if contract.status == 'completed' else 'warning' if contract.status == 'processing' else 'danger' }} fs-6">
                    {{ contract.status.title() }}
                </span>
            </div>
        </div>
    </div>
</div>

{% if contract.status == 'completed' %}
<div class="row">
    <!-- Actions Panel -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-download me-2"></i>Download Options
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if contract.docx_path %}
                    <a href="{{ url_for('download_file', contract_id=contract.id, file_type='docx') }}" 
                       class="btn btn-primary">
                        <i class="fas fa-file-word me-2"></i>Download Word (.docx)
                    </a>
                    {% endif %}
                    
                    {% if contract.pdf_path %}
                    <a href="{{ url_for('download_file', contract_id=contract.id, file_type='pdf') }}" 
                       class="btn btn-danger">
                        <i class="fas fa-file-pdf me-2"></i>Download PDF
                    </a>
                    {% endif %}
                </div>
                
                <hr>
                
                <div class="d-grid gap-2">
                    <a href="{{ url_for('contract_history') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-list me-2"></i>View All Contracts
                    </a>
                    <a href="{{ url_for('upload_documents') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-2"></i>Create New Contract
                    </a>
                </div>
                
                <hr>
                
                <form method="POST" action="{{ url_for('delete_contract', contract_id=contract.id) }}" 
                      onsubmit="return confirm('Are you sure you want to delete this contract?')">
                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                        <i class="fas fa-trash me-2"></i>Delete Contract
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Extracted Clauses Summary -->
        {% if contract.extracted_clauses %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-search me-2"></i>AI Analysis
                </h6>
            </div>
            <div class="card-body">
                {% set clauses = contract.extracted_clauses | fromjson %}
                {% for category, items in clauses.items() %}
                    {% if items %}
                    <div class="mb-3">
                        <h6 class="text-primary">{{ category.replace('_', ' ').title() }}</h6>
                        <small class="text-muted">{{ items | length }} item(s) found</small>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Contract Preview -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-file-contract me-2"></i>Contract Preview
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printContent()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                        <i class="fas fa-expand me-1"></i>Fullscreen
                    </button>
                </div>
            </div>
            <div class="card-body" id="contractContent">
                <div class="contract-preview">
                    {% if contract.final_contract_content %}
                        {{ contract.final_contract_content | replace('\n', '<br>') | safe }}
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                            <h5>No content available</h5>
                            <p>The contract content could not be displayed.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i>Detailed AI Analysis
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if contract.extracted_clauses %}
                    {% set clauses = contract.extracted_clauses | fromjson %}
                    <div class="accordion" id="clausesAccordion">
                        {% for category, items in clauses.items() %}
                            {% if items %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ loop.index }}">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                        {{ category.replace('_', ' ').title() }} ({{ items | length }} items)
                                    </button>
                                </h2>
                                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" 
                                     data-bs-parent="#clausesAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-group list-group-flush">
                                            {% for item in items %}
                                            <li class="list-group-item">{{ item }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No analysis data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Error/Processing State -->
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card border-{{ 'danger' if contract.status == 'error' else 'warning' }}">
            <div class="card-body text-center">
                <i class="fas fa-{{ 'exclamation-triangle' if contract.status == 'error' else 'clock' }} 
                   text-{{ 'danger' if contract.status == 'error' else 'warning' }} fa-3x mb-3"></i>
                
                {% if contract.status == 'error' %}
                    <h4 class="text-danger">Processing Error</h4>
                    <p>There was an error processing this contract.</p>
                    
                    <!-- Show error logs if available -->
                    {% if contract.logs %}
                        <div class="mt-3">
                            <h6>Error Details:</h6>
                            {% for log in contract.logs %}
                                {% if log.log_level == 'ERROR' %}
                                    <div class="alert alert-danger text-start">
                                        <small>{{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else 'Unknown time' }}: {{ log.message }}</small>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                {% else %}
                    <h4 class="text-warning">Processing...</h4>
                    <p>This contract is currently being processed. Please check back in a moment.</p>
                {% endif %}
                
                <a href="{{ url_for('contract_history') }}" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Contracts
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function printContent() {
    const content = document.getElementById('contractContent').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>{{ contract.contract_name }}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { margin: 20px; }
                .contract-preview { font-family: 'Times New Roman', serif; line-height: 1.6; }
                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <h1>{{ contract.contract_name }}</h1>
            <hr>
            <div class="contract-preview">${content}</div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function toggleFullscreen() {
    const content = document.getElementById('contractContent');
    if (content.requestFullscreen) {
        content.requestFullscreen();
    }
}

// Show analysis modal if there are extracted clauses
{% if contract.extracted_clauses %}
const analysisBtn = document.createElement('button');
analysisBtn.className = 'btn btn-info btn-sm mt-2';
analysisBtn.innerHTML = '<i class="fas fa-chart-bar me-1"></i>View Analysis';
analysisBtn.setAttribute('data-bs-toggle', 'modal');
analysisBtn.setAttribute('data-bs-target', '#analysisModal');

const actionsCard = document.querySelector('.card .card-body');
if (actionsCard) {
    const hr = document.createElement('hr');
    actionsCard.appendChild(hr);
    actionsCard.appendChild(analysisBtn);
}
{% endif %}
</script>
{% endblock %}
